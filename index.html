<!DOCTYPE html>
 <meta charset="utf-8">
 <html>
   <head>
     <!-- Load d3.js -->
     <script src="https://d3js.org/d3.v5.min.js"></script>
   </head>
   <body onload='init()'>
        <label style="float: left;font-size: smaller;" for="country">Choose a year:
            <select class="box" id="selectYear" value=1990></select>
        </label>

        <svg id="viz" width=700 height=700>
        </svg>

        <script>

        async function init() {
            //Read the data
            const data = await d3.csv("data/obesity_dataset.csv");

            data.forEach(d=>{
                d.GDP=+d.GDP; 
                d.Pct_Adults_Obese=+d.Pct_Adults_Obese; 
                d.Pct_Adults_Overweight=+d.Pct_Adults_Overweight;
                d.Pct_Deaths_Obesity=+d.Pct_Deaths_Obesity;
            });

            var margin=50;
            var width=500;
            var height=500;
            var base= margin+height;

            // Add Y axis
            var y = d3.scaleLinear()
                .domain([0, 60])
                .range([ height, 0]);
            var yAxis = d3.axisLeft(y)
                .tickValues([0,10,20,30,40,50,60])
                .tickFormat(d3.format("~s"));
            //Create x-axis
            var x = d3.scaleLog()
                .domain([250, 100000])
                .range([ 0, width ]);
            var xAxis = d3.axisBottom(x)
                .tickValues([250,1000,10000,25000,50000,75000,100000])
                .tickFormat(d3.format("~s"));
            
            var continents = ["Africa", "Asia", "Europe", "North America", "South America" , "Oceania"];
            // Color scale: give me a specie name, I return a color
            var color = d3.scaleOrdinal()
            .domain(continents)
            .range(["cyan", "green", "blue", "red", "magenta", "darkorange"])

            d3.select("svg").append("g")
                .attr("transform", "translate(" + margin + "," + margin + ")")
                .call(yAxis);
            d3.select("svg").append("g")
                .attr("transform", "translate(" + margin + "," + base + ")")
                .call(xAxis);        
            
            var filteredDataYear = filterByYear(data, 1990);
            console.log(filteredDataYear);

            // Add dots
            d3.select("svg")
                .append('g')
                .attr("transform", "translate(" + margin + "," + margin + ")")
                .selectAll("dot")
                .data(filteredDataYear) //data
                .enter()
                .append("circle")
                .attr("cx", function (d) { return x(d.GDP); })
                .attr("cy", function (d) { return y(d.Pct_Adults_Obese); })
                .attr("r", function (d){ return 3})
                .style("fill", function (d) { return color(d.Continent_Name); })


            // Add one dot in the legend for each name.
            d3.select("svg")
            .append('g')
            .attr("transform", "translate(" + margin + "," + margin + ")")
            .selectAll("leyend")
            .data(continents)
            .enter()
            .append("circle")
                .attr("cx", margin)
                .attr("cy", function(d,i){ return 600 + i*25}) // 100 is where the first dot appears. 25 is the distance between dots
                .attr("r", 5)
                .style("fill", function(d){ return color(d) });
            
            // Add one dot in the legend for each name.
            d3.select("svg")
            .append('g')
            .attr("transform", "translate(" + margin + "," + margin + ")")
            .selectAll("leyendtext")
            .data(continents)
            .enter()
            .append("text")
                .attr("x", margin + 10)
                .attr("y", function(d,i){ return 600 + i*25}) // 100 is where the first dot appears. 25 is the distance between dots
                .style("fill", function(d){ return color(d)})
                .text(function(d){ return d})
                .attr("text-anchor", "left")
                .style("alignment-baseline", "middle")

        }
        


        function filterByYear(data, year){
            return data.filter(function(d) {
                return d.Year == year && d.GDP > 0;
            }) 
         }

        var years = [1990, 1995, 2000, 2010, 2015];

        var dropdown = d3
        .select("#selectYear")
        .selectAll("yearOptions")
        .data(years)
        .enter()
        .append("option")
        .text(function (d) {
            return d;
        }) // text showed in the menu
        .attr("value", function (d) {
            return d;
        });



        // A function that update the plot for a given value
        function updatePlotByYear() {
        // Get the value of the button
        var year = d3.select("#selectYear").property("value");
        var filteredDataYear = filterByYear(data, year);

            // Add Y axis
            var y = d3.scaleLinear()
                .domain([0, 60])
                .range([ height, 0]);
            var yAxis = d3.axisLeft(y)
                .tickValues([0,10,20,30,40,50,60])
                .tickFormat(d3.format("~s"));
            //Create x-axis
            var x = d3.scaleLog()
                .domain([200, 100000])
                .range([ 0, width ]);
            var xAxis = d3.axisBottom(x)
                .tickValues([1000,10000,25000,50000,75000,100000])
                .tickFormat(d3.format("~s"));

            d3.select("svg").append("g")
                .attr("transform", "translate(" + margin + "," + margin + ")")
                .call(yAxis);
            d3.select("svg").append("g")
                .attr("transform", "translate(" + margin + "," + base + ")")
                .call(xAxis);        

            // Add dots
            d3.select("svg").append('g')
                .attr("transform", "translate(" + margin + "," + margin + ")")
                .selectAll("dot")
                .transition()
                .duration(1000)
                .data(filteredDataYear)
                .enter()
                .append("circle")
                .attr("cx", function (d) { return x(d.GDP);})
                .attr("cy", function (d) { return y(d.Pct_Adults_Obese);} )
                .attr("r", function (d){ return 2});



        }


        </script>

   </body>
 </html>